<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>  
    <h1>Test Ajax</h1>
     
    <div style="margin: 20px; float:left; width: 500px; height: 500px; background-color: pink;">
        <form action="" method="get" name="form">  
            <br>  
            è¾“å…¥ç”¨æˆ·åï¼š  
            <input type="text" size="10" maxlength="8" id="userName" name="name" onblur="validate()">  
            <span id="info"></span>  
            <br>  
            è¾“å…¥å•†å“åï¼š  
            <input type="text" size="10" maxlength="8" >  
        </form>  
        <p>
        <select name="" id="province" onchange="validate();">
            <option value="">province</option>
            <option value="Fujian">Fujian</option>
            <option value="Beijing">Beijing</option>
        </select>&nbsp;
        <select name="" id="city">
            <option value="">city</option>
        </select>&nbsp;
        <select name="" id="county">
            <option value="">county</option>
        </select>
    </div>    
    <div style="margin: 20px; float:left; width: 500px; height: 500px; background-color: pink;">
        <h1>refresh time: 5s</h1>
        <table class="stock" border="1px solid white" >
            <tr><td align="center" colspan="3">ğŸ˜€</td></tr>
            <tr><td>market</td><td>recent quotation</td><td>u&d</td></tr>
            <tr><td>London</td><td id="ld" align="center" >568.2</td><td>â†‘:221.3</td></tr>
            <tr><td>Taiwan</td><td id="tw" align="center" >173.4</td><td>â†‘:146.5</td></tr>
            <tr><td>Tokyo</td><td id="dj" align="center" >0</td><td>â†“:999.8</td></tr>


        </table>
    </div>    


</body>  
<script src="js/jquery-3.4.1.js"></script>
<script type="text/javascript">
    var req;
    var req02;
    //get id
    function $(id){
        return document.getElementById(id);
    }

    //load
    function loadAjax() {  
        //è·å–è¡¨å•æäº¤çš„å†…å®¹  
        var myReq;
                    
        //åˆ›å»ºä¸€ä¸ªXMLHttpRequestå¯¹è±¡req  
        if(window.XMLHttpRequest) {  
            //IE7, Firefox, Operaæ”¯æŒ  
            myReq = new XMLHttpRequest();  
        }else if(window.ActiveXObject) {  
            //IE5,IE6æ”¯æŒ  
            myReq = new ActiveXObject("Microsoft.XMLHTTP");  
        }  

        return myReq;
                    
    }  

    function refresh(){

        req02=loadAjax();
   
        var url="/UsersManager3.0/RefreshController";
        var data="city[]=jj&city[]=hh&city[]=nn";
        
        req02.open("POST", url, true);  
        
        //post must with head
        req02.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        
        //onreadystatechangeå±æ€§å­˜æœ‰å¤„ç†æœåŠ¡å™¨å“åº”çš„å‡½æ•°,æœ‰5ä¸ªå–å€¼åˆ†åˆ«ä»£è¡¨ä¸åŒçŠ¶æ€  
        req02.onreadystatechange = function callBack(){
        	
            if(req02.readyState == 4 && req02.status == 200) {  
                //alert('ok');
                var res=eval("("+req02.responseText+")");
                
                $('ld').innerText=res[0].price;
                $('tw').innerText=res[1].price;
                $('dj').innerText=res[2].price;
            }
        }  
        req02.send(data);
    }

    //timer
    window.setInterval("refresh()",5000);
    
    //line 1
    function validate() {  
        //è·å–è¡¨å•æäº¤çš„å†…å®¹  
        // var idField = document.getElementById("userName");  
        var idField = document.getElementById("province");  
        //è®¿é—®servletï¼ŒåŒæ—¶æŠŠè·å–çš„è¡¨å•å†…å®¹idFieldåŠ å…¥urlå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿ä¼ é€’ç»™validate.do  
        //get
        //var url = "/UsersManager3.0/CheckController?id=" + escape(idField.value);                  
        //post
        var url = "/UsersManager3.0/CallCountryController";
        //escape decode string   
        var data = "province="+ escape(idField.value);                	
        //åˆ›å»ºä¸€ä¸ªXMLHttpRequestå¯¹è±¡req  
        if(window.XMLHttpRequest) {  
            //IE7, Firefox, Operaæ”¯æŒ  
            req = new XMLHttpRequest();  
        }else if(window.ActiveXObject) {  
            //IE5,IE6æ”¯æŒ  
            req = new ActiveXObject("Microsoft.XMLHTTP");  
        }  
        /* 
        open(String method,String url, boolean )å‡½æ•°æœ‰3ä¸ªå‚æ•° 
        methodå‚æ•°æŒ‡å®šå‘servletå‘é€è¯·æ±‚æ‰€ä½¿ç”¨çš„æ–¹æ³•ï¼Œæœ‰GET,POSTç­‰ 
        booleanå€¼æŒ‡å®šæ˜¯å¦å¼‚æ­¥ï¼Œtrueä¸ºä½¿ç”¨ï¼Œfalseä¸ºä¸ä½¿ç”¨ã€‚ 
        æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥æ‰èƒ½ä½“ä¼šåˆ°Ajaxå¼ºå¤§çš„å¼‚æ­¥åŠŸèƒ½ã€‚ 
        */  
        req.open("POST", url, true);  
        //post must with head
        req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        
        //onreadystatechangeå±æ€§å­˜æœ‰å¤„ç†æœåŠ¡å™¨å“åº”çš„å‡½æ•°,æœ‰5ä¸ªå–å€¼åˆ†åˆ«ä»£è¡¨ä¸åŒçŠ¶æ€  
        req.onreadystatechange = callback;  
        //sendå‡½æ•°å‘é€è¯·æ±‚  
        //line 2
        req.send(data);   
                    
    }  

    //line 4
    function callback() {  
        if(req.readyState == 4 && req.status == 200) {  
            var cities = req.responseXML.getElementsByTagName("city");
            //alert(cities.length);
            //refresh
            $('city').length=0;
            var myOption=document.createElement("option");
            myOption.innerText="city";
            $('city').appendChild(myOption);
            for(var i=0;i<cities.length;i++){
                var cityName=cities[i].childNodes[0].nodeValue;
                //alert(cityName+"");
                //createElement
                var myOption=document.createElement("option");
                myOption.value=cityName;
                myOption.innerText=cityName;
                //add
                $('city').appendChild(myOption);
            }
            
            // var msg = req.responseText;
            //ecal power
            // var msgVal=eval("("+msg+")");
            
            // show (msgVal.msg+""); 


        }  
    }  
    
    function show(str) {  
        if(str == "OK") {  
            var show = "<font color='green'>æ­å–œï¼ï¼ç”¨æˆ·åå¯ç”¨ï¼</font>";  
            document.getElementById("info").innerHTML = show;  
        }  
        else if( str == "NO") {  
            var show = "<font color='red'>å¯¹ä¸èµ·ï¼Œç”¨æˆ·åä¸å¯ç”¨ï¼ï¼è¯·é‡æ–°è¾“å…¥ï¼</font>";  
            document.getElementById("info").innerHTML = show;  
        }  
    }  

</script>
</html>